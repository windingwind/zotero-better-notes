name: Notify Telegram on Release

on:
  release:
    types: [published]

jobs:
  send_message:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Message
        env:
          RELEASE_BODY: ${{ github.event.release.body }}
          REPO_NAME: ${{ github.repository }}
          TAG_NAME: ${{ github.event.release.tag_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_URL: ${{ github.event.release.html_url }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TG_MSG_ID: ${{ secrets.TG_MSG_ID }}
        run: |
          # Convert GFM to Telegram Markdown (Legacy)
          # 1. Convert headers (### Text) to Bold (*Text*)
          # 2. Convert GFM Bold (**Text**) to Telegram Bold (*Text*)
          # 3. Escape underscores to prevent broken italics (Note: this might break some complex links with underscores)
          ESCAPED_BODY=$(echo "$RELEASE_BODY" | sed 's/^### \(.*\)$/*\1*/g' | sed 's/\*\*/\*/g' | sed 's/_/\\_/g')
          
          msg_text="
          ðŸ“¢ A new release of $REPO_NAME is published: $TAG_NAME
          Release Name: $RELEASE_NAME
          Description: 
          $ESCAPED_BODY

          You can check updates in Zotero to get the latest version, or view on GitHub: $RELEASE_URL"
          curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
          -d "chat_id=$TG_CHAT_ID" \
          --data-urlencode "text=$msg_text" \
          -d "parse_mode=Markdown" \
          -d "reply_to_message_id=$TG_MSG_ID"
